<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Using LAPACK libraries with Intel Fortran and Abaqus user subroutine | Bibekananda Datta </title> <meta name="author" content="Bibekananda Datta"> <meta name="description" content="A simple tutorial to compile and link LAPACK libraries with Intel Fortran compiler"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://bibekanandadatta.com/blog/2024/lapack-Intel-Fortran-Abaqus/"> <script src="/assets/js/theme.js?a5ca4084d3b81624bcfa01156dae2b8e"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Bibekananda</span> Datta </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About </a> </li> <li class="nav-item "> <a class="nav-link" href="/research/">Research </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">Repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/teaching/">Teaching </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">CV </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">Blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/surfboard/">Surfboard </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Using LAPACK libraries with Intel Fortran and Abaqus user subroutine</h1> <p class="post-meta"> May 09, 2024 </p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a>   ·   <a href="/blog/tag/intel-oneapi"> <i class="fa-solid fa-hashtag fa-sm"></i> Intel-oneAPI</a>   <a href="/blog/tag/abaqus"> <i class="fa-solid fa-hashtag fa-sm"></i> Abaqus</a>   <a href="/blog/tag/user-subroutine"> <i class="fa-solid fa-hashtag fa-sm"></i> user-subroutine</a>   <a href="/blog/tag/fortran"> <i class="fa-solid fa-hashtag fa-sm"></i> Fortran</a>   <a href="/blog/tag/programming"> <i class="fa-solid fa-hashtag fa-sm"></i> programming</a>   <a href="/blog/tag/visual-studio"> <i class="fa-solid fa-hashtag fa-sm"></i> Visual-Studio</a>   <a href="/blog/tag/lapack"> <i class="fa-solid fa-hashtag fa-sm"></i> LAPACK</a>     ·   <a href="/blog/category/tutorial"> <i class="fa-solid fa-tag fa-sm"></i> tutorial</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <h2 id="what-is-linear-algebra-package-lapack">What is Linear Algebra PACKage (LAPACK)</h2> <p>Linear Algebra PACKage (LAPACK) is a Fortran-based efficient library for linear algebraic operations shared under a 3-Clause BSD License. Original LAPACK was written in FORTRAN 77 but later moved to Fortran 90. Many programming languages have interfaces or wrappers for the LAPACK library. The original LAPACK is hosted on <a href="https://www.netlib.org/lapack/" rel="external nofollow noopener" target="_blank">Netlib</a>, but many software companies have their own implementations of LAPACK such as Intel has its own version of LAPACK included in the Math Kernel Library (MKL) as a part of the Intel oneAPI package and Apple has its LAPACK library within the Accelerate framework. There are also simplified Fortran 95 interface libraries to the original LAPACK however it is not standardized and interfaces vary among different implementations. With LAPACK, you do not need to write standard linear algebraic procedures. See the <a href="https://www.netlib.org/lapack/explore-html/" rel="external nofollow noopener" target="_blank">Netlib LAPACK documentation</a> to see what type of subroutines are available in LAPACK. The primary objective of this blog is to test the LAPACK library from Intel MKL with Abaqus user subroutines.</p> <h2 id="installing-visual-studio-and-intel-oneapi">Installing Visual Studio and Intel oneAPI</h2> <p>To use LAPACK subroutines from the Intel MKL in your Fortran codes, first, you need to have Microsoft Visual Studio and Intel oneAPI Toolkits (Base and HPC) installed.</p> <p>The community edition of Microsoft Visual Studio is free and the Intel oneAPI has been free for the last few years.</p> <ul> <li>Make sure to install compatible versions of Microsoft Visual Studio and Intel oneAPI packages. Use Google to find the compatible versions. Hyperlinks to the Intel website for the developers’ guide never work.</li> <li>Install Visual Studio first. The installation procedure is simple, and stick to the default option, but make sure to select the <strong>Desktop development with C++</strong> option during installation.</li> <li>Now proceed to Install oneAPI packages; first the Base Toolkit and then the HPC Toolkit. Stick to the default installation procedure. Intel oneAPI packages should be installed in the <code class="language-plaintext highlighter-rouge">C:\Program Files (x86)\Intel\oneAPI</code> directory.</li> </ul> <p>Once the installation is complete, you can access <strong>Intel oneAPI Command Prompt</strong> from the Program Menu on Windows.</p> <h2 id="compiling-and-linking-lapack-subroutines-from-the-command-line">Compiling and linking LAPACK subroutines from the command line</h2> <p>Save the following Fortran program as <code class="language-plaintext highlighter-rouge">mkl_test.f90</code> in your working directory. This code is seemingly simple; it calls two subroutines <code class="language-plaintext highlighter-rouge">lapack_test()</code> and <code class="language-plaintext highlighter-rouge">lapack95_test()</code> from the main program which solves for a simple 3x3 linear system using the <code class="language-plaintext highlighter-rouge">dgesv</code> subroutine from <code class="language-plaintext highlighter-rouge">LAPACK</code> and the <code class="language-plaintext highlighter-rouge">gesv</code> interface from Intel MKL’s <code class="language-plaintext highlighter-rouge">LAPACK95</code> library. In both cases, it prints the results on the screen.</p> <details><summary>Click here to see the Fortran code</summary> <div class="language-fortran highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">program</span><span class="w"> </span><span class="n">main</span><span class="w">

  </span><span class="k">call</span><span class="w"> </span><span class="n">lapack_test</span><span class="p">()</span><span class="w">

  </span><span class="k">call</span><span class="w"> </span><span class="n">lapack95_test</span><span class="p">()</span><span class="w">

</span><span class="k">end</span><span class="w"> </span><span class="k">program</span><span class="w"> </span><span class="n">main</span><span class="w">


</span><span class="k">subroutine</span><span class="w"> </span><span class="n">lapack_test</span><span class="p">()</span><span class="w">

  </span><span class="k">use</span><span class="w"> </span><span class="n">lapack95</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="p">:</span><span class="w"> </span><span class="n">gesv</span><span class="w">
  </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w">
  </span><span class="kt">double precision</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">A</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">x</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w">

  </span><span class="c1">! required for original lapack</span><span class="w">
  </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">nrhs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">
  </span><span class="kt">integer</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">lda</span><span class="p">,</span><span class="w"> </span><span class="n">ipiv</span><span class="p">,</span><span class="w"> </span><span class="n">ldb</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="w">   

  </span><span class="c1">! testing original lapack routine</span><span class="w">
  </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
    </span><span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.0d0</span><span class="w">
    </span><span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="mi">+1</span><span class="p">:</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.0d0</span><span class="w">
    </span><span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5.0d0</span><span class="w">
    </span><span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w">
  </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">

  </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="w">
  </span><span class="n">lda</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w">   </span><span class="c1">! row count of A</span><span class="w">
  </span><span class="n">ldb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="w">     </span><span class="c1">! row count of b</span><span class="w">

  </span><span class="c1">! A returns as LU factorization, x is the solution</span><span class="w">
  </span><span class="k">call</span><span class="w"> </span><span class="n">dgesv</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">nrhs</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">lda</span><span class="p">,</span><span class="w"> </span><span class="n">ipiv</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">ldb</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">)</span><span class="w">
  </span><span class="k">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s1">'results from original lapack subroutine: '</span><span class="w">
  </span><span class="k">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="w">

</span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">lapack_test</span><span class="w">

</span><span class="k">subroutine</span><span class="w"> </span><span class="n">lapack95_test</span><span class="p">()</span><span class="w">

  </span><span class="k">use</span><span class="w"> </span><span class="n">lapack95</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="p">:</span><span class="w"> </span><span class="n">gesv</span><span class="w">
  </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w">
  </span><span class="kt">double precision</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">A</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">x</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w">

  </span><span class="c1">! testing lapack95 routines</span><span class="w">
  </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
    </span><span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.0d0</span><span class="w">
    </span><span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="mi">+1</span><span class="p">:</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.0d0</span><span class="w">
    </span><span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5.0d0</span><span class="w">
    </span><span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w">
  </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">

  </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="w">
  </span><span class="c1">! A returns as LU factorization, x is the solution</span><span class="w">
  </span><span class="k">call</span><span class="w"> </span><span class="n">gesv</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">x</span><span class="p">)</span><span class="w">    
  </span><span class="k">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s1">'results from lapack95 module: '</span><span class="w">
  </span><span class="k">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="n">x</span><span class="w">

</span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">lapack95_test</span><span class="w">
</span></code></pre></div></div> </details> <p>If you are already familiar with Microsoft Visual Studio environment, you can create a project there, compile and link the code to Intel MKL libraries to create the executables. You can find other tutorials or blog to learn how to do that. Here we will use the command line option compile and link the code to generate the executable. Open the <strong>Intel one API Command Prompt for Intel 64 for Visual Studio 2019</strong> terminal from the Windows program menu. A simple Fortran program (without MKL library or external library) can be compiled and linked using:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ifort <span class="nt">-o</span> <span class="nb">test </span>test.f90
</code></pre></div></div> <p>Now to compile and link a Fortran code that includes MKL components, we need to add the <code class="language-plaintext highlighter-rouge">/Qmkl</code> flag before the <code class="language-plaintext highlighter-rouge">-o</code>. Since the code also uses the LAPACK95 module from Intel MKL, we need to add <code class="language-plaintext highlighter-rouge">mkl_lapack95_ilp64.lib</code> for further linking.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ifort /Qmkl <span class="nt">-o</span> mkl_test mkl_test.f90 mkl_lapack95_ilp64.lib
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">ifort</code> is the Intel Fortran compiler, <code class="language-plaintext highlighter-rouge">/Qmkl</code> option tells compiler to link standard <code class="language-plaintext highlighter-rouge">.lib</code> files related to MKL (it’s a shortcut), and <code class="language-plaintext highlighter-rouge">-o</code> specifies object file. The last option <code class="language-plaintext highlighter-rouge">mkl_lapack95_ilp64.lib</code> is to link the LAPACK95 interface library to the object file (this is not a part of the core MKL).</p> <p>This will generate the <code class="language-plaintext highlighter-rouge">mkl_test.exe</code> executable and <code class="language-plaintext highlighter-rouge">mkl_test.obj</code> object file in the working directory. You can then run the code from any Windows terminal using:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./mkl_test
</code></pre></div></div> <p>This will now execute and print out results from two different subroutines used in the code. Now LAPACK95 interfaces may appeal to you more than the original LAPACK subroutines because of the simplicity. But there is a caveat, LAPACK95 implementations are not as universal as the original LAPACK. LAPACK95 interfaces included in the Intel MKL and provided by Netlib are different. Your codes may have compatibility issues based on which library and compiler are being used. So it is probably best to use the original LAPACK subroutines and write your own wrappers.</p> <blockquote class="block-tip"> <h5 id="tip">TIP</h5> <p>If you are using a Linux or Unix-based operating system (macOS), you can follow <a href="https://fortran-lang.org/learn/building_programs/managing_libraries/" rel="external nofollow noopener" target="_blank">this simple tutorial on fortran-lang.org</a> to learn how to compile source codes and link libraries.</p> </blockquote> <h2 id="using-lapack-libraries-with-abaqus-user-subroutines">Using LAPACK libraries with Abaqus user subroutines</h2> <p>If you are looking to use LAPACK with Abaqus user subroutines, I am assuming, you already have configured Abaqus to compile and link user subroutines. If you have not done it yet, <a href="https://www.bibekanandadatta.com/blog/2021/link-intel-and-vs-abaqus-2020/" rel="external nofollow noopener" target="_blank">follow the steps described in a previous blog post</a>. At the end of the post, it is shown how to configure the Abaqus environment file to use the MKL library.</p> <blockquote> <p>You need to have <strong>admin</strong> access to make changes described in that blog post. If you are working on a shared computer cluster, ask the <strong>system administrator</strong> to make changes for you.</p> </blockquote> <p>In case you do not have <strong>admin</strong> access or are unable to make changes for compatibility reasons, you can add a <code class="language-plaintext highlighter-rouge">abaqus_v6.env</code> file to your home directory or project’s working directory with customized compiling options as shown below for Windows platform. Notice,</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># job-specific abaqus_v6 environment file (Windows)</span>
<span class="c"># this should be located in the working directory</span>

compile_fortran +<span class="o">=</span> <span class="o">[</span><span class="s1">'/Qmkl:sequential'</span><span class="o">]</span>
</code></pre></div></div> <p>For Linux, you need to change the compiler option to <code class="language-plaintext highlighter-rouge">-mkl=sequential</code> like below.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># job-specific abaqus_v6 environment file (Linux)</span>
<span class="c"># this should be located in the working directory</span>

compile_fortran +<span class="o">=</span> <span class="o">[</span><span class="s1">'-mkl=sequential'</span><span class="o">]</span>
</code></pre></div></div> <p>This command will extend the default compiler options provided by Abaqus.</p> <blockquote class="block-tip"> <h5 id="tip-1">TIP</h5> <p>If you write an Abaqus user subroutine that uses Intel MKL or other external libraries, it is perhaps better to share the <code class="language-plaintext highlighter-rouge">abaqus_v6.env</code> file with other users to execute your code.</p> </blockquote> <h3 id="writing-and-testing-abaqus-user-subroutine-with-lapack">Writing and testing Abaqus user subroutine with LAPACK</h3> <p>Now we will include the <code class="language-plaintext highlighter-rouge">lapack_test()</code> subroutine to the Abaqus <code class="language-plaintext highlighter-rouge">UEL</code> subroutine interface. For the simple (and dummy) model we built, Abaqus will call the <code class="language-plaintext highlighter-rouge">UEL</code> subroutine for that. Within the <code class="language-plaintext highlighter-rouge">UEL</code> subroutine, we call the <code class="language-plaintext highlighter-rouge">lapack_test()</code> followed by calling the <code class="language-plaintext highlighter-rouge">xit</code> function from Abaqus to terminate the program. Copy and save the following code as <code class="language-plaintext highlighter-rouge">uel_mkl.for</code> in your working directory.</p> <details><summary>Click here to see the Abaqus UEL subroutine code</summary> <div class="language-fortran highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">      </span><span class="k">SUBROUTINE</span><span class="w"> </span><span class="n">UEL</span><span class="p">(</span><span class="n">RHS</span><span class="p">,</span><span class="n">AMATRX</span><span class="p">,</span><span class="n">SVARS</span><span class="p">,</span><span class="n">ENERGY</span><span class="p">,</span><span class="n">NDOFEL</span><span class="p">,</span><span class="n">NRHS</span><span class="p">,</span><span class="n">NSVARS</span><span class="p">,</span><span class="w">
     </span><span class="mi">1</span><span class="w"> </span><span class="n">PROPS</span><span class="p">,</span><span class="n">NPROPS</span><span class="p">,</span><span class="n">COORDS</span><span class="p">,</span><span class="n">MCRD</span><span class="p">,</span><span class="n">NNODE</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">DU</span><span class="p">,</span><span class="n">V</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">JTYPE</span><span class="p">,</span><span class="n">TIME</span><span class="p">,</span><span class="n">DTIME</span><span class="p">,</span><span class="w">
     </span><span class="mi">2</span><span class="w"> </span><span class="n">KSTEP</span><span class="p">,</span><span class="n">KINC</span><span class="p">,</span><span class="n">JELEM</span><span class="p">,</span><span class="n">PARAMS</span><span class="p">,</span><span class="n">NDLOAD</span><span class="p">,</span><span class="n">JDLTYP</span><span class="p">,</span><span class="n">ADLMAG</span><span class="p">,</span><span class="n">PREDEF</span><span class="p">,</span><span class="n">NPREDF</span><span class="p">,</span><span class="w">
     </span><span class="mi">3</span><span class="w"> </span><span class="n">LFLAGS</span><span class="p">,</span><span class="n">MLVARX</span><span class="p">,</span><span class="n">DDLMAG</span><span class="p">,</span><span class="n">MDLOAD</span><span class="p">,</span><span class="n">PNEWDT</span><span class="p">,</span><span class="n">JPROPS</span><span class="p">,</span><span class="n">NJPROP</span><span class="p">,</span><span class="n">PERIOD</span><span class="p">)</span><span class="w">

      </span><span class="k">INCLUDE</span><span class="w"> </span><span class="s1">'ABA_PARAM.INC'</span><span class="w">

      </span><span class="k">DIMENSION</span><span class="w"> </span><span class="n">RHS</span><span class="p">(</span><span class="n">MLVARX</span><span class="p">,</span><span class="o">*</span><span class="p">),</span><span class="n">AMATRX</span><span class="p">(</span><span class="n">NDOFEL</span><span class="p">,</span><span class="n">NDOFEL</span><span class="p">),</span><span class="n">PROPS</span><span class="p">(</span><span class="o">*</span><span class="p">),</span><span class="w">
     </span><span class="mi">1</span><span class="w"> </span><span class="n">SVARS</span><span class="p">(</span><span class="o">*</span><span class="p">),</span><span class="n">ENERGY</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="n">COORDS</span><span class="p">(</span><span class="n">MCRD</span><span class="p">,</span><span class="n">NNODE</span><span class="p">),</span><span class="n">U</span><span class="p">(</span><span class="n">NDOFEL</span><span class="p">),</span><span class="w">
     </span><span class="mi">2</span><span class="w"> </span><span class="n">DU</span><span class="p">(</span><span class="n">MLVARX</span><span class="p">,</span><span class="o">*</span><span class="p">),</span><span class="n">V</span><span class="p">(</span><span class="n">NDOFEL</span><span class="p">),</span><span class="n">A</span><span class="p">(</span><span class="n">NDOFEL</span><span class="p">),</span><span class="n">TIME</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">PARAMS</span><span class="p">(</span><span class="o">*</span><span class="p">),</span><span class="w">
     </span><span class="mi">3</span><span class="w"> </span><span class="n">JDLTYP</span><span class="p">(</span><span class="n">MDLOAD</span><span class="p">,</span><span class="o">*</span><span class="p">),</span><span class="n">ADLMAG</span><span class="p">(</span><span class="n">MDLOAD</span><span class="p">,</span><span class="o">*</span><span class="p">),</span><span class="n">DDLMAG</span><span class="p">(</span><span class="n">MDLOAD</span><span class="p">,</span><span class="o">*</span><span class="p">),</span><span class="w">
     </span><span class="mi">4</span><span class="w"> </span><span class="n">PREDEF</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">NPREDF</span><span class="p">,</span><span class="n">NNODE</span><span class="p">),</span><span class="n">LFLAGS</span><span class="p">(</span><span class="o">*</span><span class="p">),</span><span class="n">JPROPS</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">


      </span><span class="c1">! user coding to define RHS, AMATRX, SVARS, ENERGY, and PNEWDT</span><span class="w">
      
      </span><span class="k">call</span><span class="w"> </span><span class="n">lapack_test</span><span class="p">()</span><span class="w">
      </span><span class="k">call</span><span class="w"> </span><span class="n">xit</span><span class="w">


      </span><span class="k">RETURN</span><span class="w">
      </span><span class="k">END</span><span class="w">


      </span><span class="k">subroutine</span><span class="w"> </span><span class="n">lapack_test</span><span class="p">()</span><span class="w">
        
        </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w">
        </span><span class="kt">double precision</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">A</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">x</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w">
      
        </span><span class="c1">! required for original lapack</span><span class="w">
        </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">nrhs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">
        </span><span class="kt">integer</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">lda</span><span class="p">,</span><span class="w"> </span><span class="n">ipiv</span><span class="p">,</span><span class="w"> </span><span class="n">ldb</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="w">   
      
        </span><span class="c1">! testing original lapack routine</span><span class="w">
        </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
          </span><span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.0d0</span><span class="w">
          </span><span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="mi">+1</span><span class="p">:</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.0d0</span><span class="w">
          </span><span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5.0d0</span><span class="w">
          </span><span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w">
        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
      
        </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="w">
        </span><span class="n">lda</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w">   </span><span class="c1">! row count of A</span><span class="w">
        </span><span class="n">ldb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="w">     </span><span class="c1">! row count of b</span><span class="w">
      
        </span><span class="c1">! A returns as LU factorization, x is the solution</span><span class="w">
        </span><span class="k">call</span><span class="w"> </span><span class="n">dgesv</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">nrhs</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">lda</span><span class="p">,</span><span class="w"> </span><span class="n">ipiv</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">ldb</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">)</span><span class="w">
        </span><span class="k">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s1">'results from lapack subroutine: '</span><span class="w">
        </span><span class="k">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="w">

      </span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">lapack_test</span><span class="w">
</span></code></pre></div></div> </details> <h3 id="executing-user-subroutine-with-a-dummy-abaqus-model">Executing user subroutine with a dummy Abaqus model</h3> <p>Since we chose to test the LAPACK subroutine inside the Abaqus UEL subroutine, we need to build an Abaqus model with a user element. Remember, our Abaqus subroutine does not do anything but perform a simple linear algebra calculation. So we do not need a real Abaqus model, rather we need something minimalistic that can help us to execute the subroutine. Following is a simple example of a user element, where I defined a single 4-node quadrilateral element with one property and static step. We did not apply any boundary or loading condition to this. Copy the following input file and save is as <code class="language-plaintext highlighter-rouge">test.inp</code> in the working directory.</p> <details><summary>Click here to see the Abaqus input file</summary> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>*User element, type=U1, nodes=4, coordinates=2, properties=1, iproperties=0
1, 2
*Node
1, 0., 0.
2, 1., 0.
3, 0., 1.
4, 1., 1.
*Element, type=U1, elset=all
1, 1, 2, 4, 3
*Uel property, elset=all
1.0
*Step, name=test
*Static
1., 1., 1.E-3, 1.
*End step
</code></pre></div></div> </details> <p>Abaqus UEL subroutine needs to be executed from the command line. From the <strong>PowerShell</strong> terminal, <strong>Windows Command Prompt</strong>, or <strong>Abaqus Command</strong> terminal, you can execute the subroutine with the sample input file using the following command:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>abaqus interactive <span class="nv">job</span><span class="o">=</span><span class="nb">test </span><span class="nv">user</span><span class="o">=</span>uel_mkl.for
</code></pre></div></div> <p>This will compile and link the user subroutine to the Abaqus executable and run it from the command line. As we already discussed, this is not a real Abaqus model or user subroutine code, we are not hoping to get any real finite element result. Executing this subroutine will just print out the same output as before on the terminal before exiting Abaqus with an error (remember, we used <code class="language-plaintext highlighter-rouge">xit</code> function for termination).</p> <h2 id="lapack-resources">LAPACK resources</h2> <p>Using LAPACK is not as intuitive or straightforward as using MATLAB or NumPy. Look into the documentation carefully and you can use the following to find what LAPACK subroutines to use and how to use them for specific task.</p> <ul> <li><a href="https://www.intel.com/content/www/us/en/developer/tools/oneapi/onemkl-function-finding-advisor.html#gs.8k31mo" rel="external nofollow noopener" target="_blank">Intel oneAPI LAPACK Function Finding Advisor</a></li> <li><a href="https://github.com/numericalalgorithmsgroup/LAPACK_examples" rel="external nofollow noopener" target="_blank">LAPACK Examples by NAG library</a></li> </ul> <h2 id="bonus-item-adding-intel-oneapi-command-prompt-to-powershell-and-windows-terminal">Bonus item: Adding Intel oneAPI Command Prompt to PowerShell and Windows Terminal</h2> <p>You can not run the Intel oneAPI command line from PowerShell terminal directly, but you can run it from the original Windows Command Prompt terminal. However, Command Prompt, even the default old PowerShell (PowerShell 5) does not have the latest features such as auto-completion. If you have not used the new PowerShell, it’s highly recommended on Windows. Download and install the <a href="https://github.com/PowerShell/PowerShell" rel="external nofollow noopener" target="_blank">latest version of PowerShell 7 from here</a>. The new PowerShell executable is named as <code class="language-plaintext highlighter-rouge">pwsh.exe</code>.</p> <p><a href="https://learn.microsoft.com/en-us/windows/terminal/" rel="external nofollow noopener" target="_blank">Windows Terminal App</a> is great managing different Shell profiles. Terminal does not have to be boring; you can customize your terminal experience a lot using this app. Download and install the <a href="https://github.com/microsoft/terminal" rel="external nofollow noopener" target="_blank">Windows Terminal app from here</a>. Once installed, you can manage different Shell profiles there (Cmd, PowerShell, pwsh, WSL, etc.). To add Intel oneAPI profile there,</p> <ul> <li> <p>Open the app, and from the dropdown menu on the top bar, click on <strong>Settings</strong>.</p> </li> <li> <p>Now scroll down along the left-side menu bar, click add a new profile, select the option <strong>Empty New Profil</strong>. Name the new profile as <strong>Intel oneAPI</strong> and add the following following to the <strong>Command Line</strong> option.</p> <div class="language-bash highlighter-rouge"> <div class="highlight"><pre class="highlight"><code>cmd.exe /k <span class="s2">""</span>C:<span class="se">\P</span>rogram Files <span class="o">(</span>x86<span class="o">)</span><span class="se">\I</span>ntel<span class="se">\o</span>neAPI<span class="se">\s</span>etvars.bat<span class="s2">" intel64 vs2019"</span> <span class="o">&amp;&amp;</span> pwsh
</code></pre></div> </div> <p>Other options to set the new profile are trivial. Now you can save the profile. When you start the profile from the Terminal app, this will execute Windows command prompt first, then it will set the environment variables for Intel oneAPI and Visual Studio, and then run the new PowerShell 7 (<code class="language-plaintext highlighter-rouge">pwsh.exe</code>). You can now compile and build program using Intel Fortran in a modern terminal environment.</p> </li> </ul> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2021/link-intel-and-vs-abaqus-2020/">Linking Intel oneAPI and Visual Studio with Abaqus</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/getting-started-with-fenicsx/">Getting started with FEniCSx</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/licensing-and-citing-online/">Licensing and citing academic software and tutorials</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/latex-powerpoint-vscode-mac/">LaTeX in MS PowerPoint and VS Code on macOS</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2021/relearning-mathematics/">Relearning mathematics</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> Copyright © 2024 Bibekananda Datta. All rights reserved. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?b7816bd189846d29eded8745f9c4cf77"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>